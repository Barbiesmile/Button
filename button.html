// app/api/send/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "edge";

const LINE_CHANNEL_ACCESS_TOKEN = "aYoHZr2pMButKIE7/gxjt6Ei3r8f/myPXF6nP1Akxl9ig8STOd/Fpub8lEXWU85GhXDcdDSfDV1bHlAVgV22qrzP84B9qnzQ6KxOFmAY1auzkGkzmZOXr07CIu/Co53PjqXoMYG0BFZprhRdmBsO9AdB04t89/1O/w1cDnyilFU=";

function extractTimeFromDate(dateString: string): string {
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return "";
  return date.toLocaleTimeString("zh-TW", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  });
}

async function sendReminder(userId: string, date: string) {
  const time = extractTimeFromDate(date);
  const message = `å—¨å—¨~ğŸ”‰é ç´„æé†’é€šçŸ¥\næˆ‘å€‘æ˜å¤© ${time} è¦‹å”·ğŸŒğŸŒ`;

  const res = await fetch("https://api.line.me/v2/bot/message/push", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${LINE_CHANNEL_ACCESS_TOKEN}`,
    },
    body: JSON.stringify({
      to: userId,
      messages: [
        {
          type: "text",
          text: message,
        },
      ],
    }),
  });

  return res;
}

export async function POST(req: NextRequest) {
  try {
    const { userId, date } = await req.json();

    if (!userId || !date) {
      return NextResponse.json({ error: "ç¼ºå°‘ userId æˆ– date" }, { status: 400 });
    }

    const res = await sendReminder(userId, date);

    if (!res.ok) {
      const errText = await res.text();
      return NextResponse.json({ error: "LINE ç™¼é€å¤±æ•—", detail: errText }, { status: 500 });
    }

    return NextResponse.json({ success: true });
  } catch (err: any) {
    return NextResponse.json({ error: "ä¼ºæœå™¨éŒ¯èª¤", detail: err.message }, { status: 500 });
  }
}

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const userId = searchParams.get("userId") ?? "";
    const date = searchParams.get("date") ?? "";

    if (!userId || !date) {
      return NextResponse.json({ error: "ç¼ºå°‘ userId æˆ– date" }, { status: 400 });
    }

    const res = await sendReminder(userId, date);

    if (!res.ok) {
      const errText = await res.text();
      return NextResponse.json({ error: "LINE ç™¼é€å¤±æ•—", detail: errText }, { status: 500 });
    }

    return NextResponse.json({ success: true });
  } catch (err: any) {
    return NextResponse.json({ error: "ä¼ºæœå™¨éŒ¯èª¤", detail: err.message }, { status: 500 });
  }
}
