// app/api/send/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "edge";

// Airtable + LINE è¨­å®š
const AIRTABLE_API_KEY = "patitOHNhbvRSL5ao.82017354382680e3dfbe9259e6fd446fd1c9f2d90bc52225d4e14d3d7d53068f";
const AIRTABLE_BASE_ID = "appQ1jsnnFpGWs00U";
const AIRTABLE_TABLE_ID = "tblrtMjtPuEIrHC3U"; // é ç´„è¡¨çš„ Table ID

const LINE_CHANNEL_ACCESS_TOKEN = "aYoHZr2pMButKIE7/gxjt6Ei3r8f/myPXF6nP1Akxl9ig8STOd/Fpub8lEXWU85GhXDcdDSfDV1bHlAVgV22qrzP84B9qnzQ6KxOFmAY1auzkGkzmZOXr07CIu/Co53PjqXoMYG0BFZprhRdmBsO9AdB04t89/1O/w1cDnyilFU=";

// æ™‚é–“æ ¼å¼è½‰æ›å·¥å…·
function extractTimeFromDate(dateString: string): string {
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return "";
  return date.toLocaleTimeString("zh-TW", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  });
}

// æŸ¥è©¢ Airtable ä¸­å°æ‡‰ userId_ çš„é ç´„
async function getReservationByUserId(userId: string) {
  const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_ID}?filterByFormula=({userId_}='${userId}')&maxRecords=1`;

  const res = await fetch(url, {
    headers: {
      Authorization: `Bearer ${AIRTABLE_API_KEY}`,
    }
  });

  if (!res.ok) {
    throw new Error(`Airtable API error: ${res.statusText}`);
  }

  const data = await res.json();
  if (!data.records || data.records.length === 0) {
    return null;
  }
  return data.records[0];
}

// ä¸»ç¨‹å¼å…¥å£
export async function POST(req: NextRequest) {
  try {
    const { userId, date } = await req.json(); // Airtable æŒ‰éˆ•å‚³ä¾†çš„åƒæ•¸

    if (!userId || !date) {
      return NextResponse.json({ error: "ç¼ºå°‘ userId æˆ– date" }, { status: 400 });
    }

    // æŸ¥ Airtable æ˜¯å¦æœ‰å°æ‡‰çš„é ç´„è³‡æ–™
    const reservation = await getReservationByUserId(userId);
    if (!reservation) {
      return NextResponse.json({ error: "æ‰¾ä¸åˆ°é ç´„è³‡æ–™" }, { status: 404 });
    }

    // çµ„è¨Šæ¯æ–‡å­—
    const time = extractTimeFromDate(date);
    const message = `å—¨å—¨~ğŸ”‰é ç´„æé†’é€šçŸ¥\næˆ‘å€‘æ˜å¤© ${time} è¦‹å”·ğŸŒğŸŒ`;

    // ç™¼é€ LINE è¨Šæ¯
    const lineRes = await fetch("https://api.line.me/v2/bot/message/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${LINE_CHANNEL_ACCESS_TOKEN}`,
      },
      body: JSON.stringify({
        to: userId,
        messages: [{ type: "text", text: message }],
      }),
    });

    if (!lineRes.ok) {
      const errText = await lineRes.text();
      return NextResponse.json({ error: "LINE ç™¼é€å¤±æ•—", detail: errText }, { status: 500 });
    }

    return NextResponse.json({ success: true });

  } catch (err: any) {
    return NextResponse.json({ error: "ä¼ºæœå™¨éŒ¯èª¤", detail: err.message }, { status: 500 });
  }
}
